<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>M3U8 Dynamic Player</title>
<link href="https://unpkg.com/video.js@8/dist/video-js.css" rel="stylesheet"/>
<script src="https://unpkg.com/video.js@8/dist/video.min.js"></script>
</head>
<body style="background:#0b1020;color:white;font-family:Arial;padding:20px;">
<h2>M3U8 Auto Watcher (Dynamic)</h2>

<video id="player" class="video-js" controls preload="auto" width="800" height="450"></video>

<div style="margin-top:20px;">
  <input id="u" style="width:400px;" placeholder="https://www.freeshot.live/live-tv/a-bola-tv/336"/>
  <button onclick="setTarget()">Changer de page</button>
</div>

<div style="margin-top:10px;">
  Source: <span id="src">—</span><br>
  Page: <span id="tgt">—</span><br>
  SSE: <span id="sse">…</span>
</div>

<script>
const player = videojs('player',{autoplay:false});

function inject(m){
  document.getElementById('src').textContent=m;
  player.src({src:m,type:'application/x-mpegURL'});
  player.play().catch(()=>{});
}

function setTarget(){
  const url=document.getElementById('u').value.trim();
  fetch('/set-target?url='+encodeURIComponent(url));
}

const es=new EventSource('/events');
es.addEventListener('open',()=>document.getElementById('sse').textContent='connecté');
es.addEventListener('error',()=>document.getElementById('sse').textContent='déconnecté');
es.addEventListener('init',e=>{
  const d=JSON.parse(e.data);
  if(d.m3u8) inject(d.m3u8);
  document.getElementById('tgt').textContent=d.target;
});
es.addEventListener('update',e=>{
  const d=JSON.parse(e.data);
  if(d.m3u8) inject(d.m3u8);
  document.getElementById('tgt').textContent=d.target;
});
</script>
</body>
</html>
